<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="theme-color" content="#FFFFFF">
<title>Buyurtmalar</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap');
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'Poppins',-apple-system,sans-serif;background:#F5F5F5;color:#202124;min-height:100vh;min-height:100dvh;-webkit-overflow-scrolling:touch;}

.page-header{background:#fff;padding:calc(env(safe-area-inset-top,0px) + 0.75rem) 1rem 0.8rem;position:sticky;top:0;z-index:100;
  display:flex;align-items:center;gap:0.75rem;box-shadow:0 2px 8px rgba(0,0,0,0.05)}
.back-btn{background:transparent;border:none;padding:0.4rem;cursor:pointer;
  display:flex;align-items:center;justify-content:center;border-radius:50%;flex-shrink:0}
.back-btn:active{background:#F5F5F5}
.page-title{font-size:1.1rem;font-weight:700;flex:1}

/* ‚úÖ FIX: data:image flag o'rniga UZ/RU pill (100% ishlaydi) */
.lang-flag{
  width:38px;height:38px;border-radius:50%;
  overflow:hidden;cursor:pointer;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;
  background:#F2F2F2;color:#202124;
  font-size:14px;font-weight:900;
  border:1.5px solid #E8E8E8;
}

/* ‚îÄ‚îÄ Coin pill ‚îÄ‚îÄ */
.coin-pill{display:inline-flex;align-items:center;gap:0.35rem;
  background:#fff;border:1.5px solid #E8E8E8;border-radius:20px;
  padding:0.28rem 0.65rem;font-size:0.82rem;font-weight:800;color:#202124;
  box-shadow:0 1px 4px rgba(0,0,0,0.08);}
.coin-pill img{width:18px;height:18px;}

.content{padding:1rem;padding-bottom:calc(env(safe-area-inset-bottom,0px) + 1rem)}

/* ‚îÄ‚îÄ Active order banner ‚îÄ‚îÄ */
.active-order-banner{
  background:linear-gradient(135deg,#FAB95B,#B71C1C);
  border-radius:18px;padding:1.1rem 1.1rem 1.25rem;
  margin-bottom:1rem;color:#fff;position:relative;overflow:hidden}
.active-order-banner::before{
  content:'';position:absolute;width:180px;height:180px;
  background:rgba(255,255,255,0.07);border-radius:50%;
  top:-60px;right:-50px}
.aob-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:0.75rem}
.aob-label{font-size:0.7rem;font-weight:700;opacity:0.75;text-transform:uppercase;letter-spacing:0.5px}
.aob-id{font-size:1rem;font-weight:800}
.aob-status{font-size:0.78rem;font-weight:700;background:rgba(255,255,255,0.2);
  border-radius:20px;padding:0.25rem 0.7rem}
.aob-steps{display:flex;align-items:center;gap:0;margin-bottom:1rem}
.step{display:flex;flex-direction:column;align-items:center;flex:1;position:relative}
.step-dot{width:28px;height:28px;border-radius:50%;background:rgba(255,255,255,0.25);
  display:flex;align-items:center;justify-content:center;font-size:0.95rem;
  border:2px solid rgba(255,255,255,0.4);position:relative;z-index:1}
.step-dot.done{background:rgba(255,255,255,0.9);border-color:transparent}
.step-dot.active{background:#fff;border-color:#fff;
  box-shadow:0 0 0 4px rgba(255,255,255,0.25)}
.step-line{position:absolute;top:14px;left:50%;width:100%;height:2px;
  background:rgba(255,255,255,0.25);z-index:0}
.step-line.done{background:rgba(255,255,255,0.7)}
.step-label{font-size:0.6rem;font-weight:600;opacity:0.8;margin-top:0.3rem;text-align:center;
  white-space:nowrap}

/* ‚îÄ‚îÄ 1-min cancel timer ‚îÄ‚îÄ */
.cancel-wrap{display:flex;align-items:center;gap:0.75rem;
  background:rgba(0,0,0,0.15);border-radius:12px;padding:0.7rem 0.9rem}
.cancel-ring{position:relative;width:40px;height:40px;flex-shrink:0}
.cancel-ring svg{transform:rotate(-90deg)}
.cancel-ring circle.bg{fill:none;stroke:rgba(255,255,255,0.2);stroke-width:4}
.cancel-ring circle.prog{fill:none;stroke:#fff;stroke-width:4;stroke-linecap:round;
  stroke-dasharray:113;stroke-dashoffset:0;transition:stroke-dashoffset 1s linear}
.cancel-ring .num{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  font-size:0.78rem;font-weight:800;color:#fff}
.cancel-info{flex:1}
.cancel-info .ci-label{font-size:0.7rem;opacity:0.75;font-weight:600}
.cancel-info .ci-hint{font-size:0.78rem;font-weight:700}
.cancel-btn{background:rgba(255,255,255,0.95);color:#FAB95B;border:none;
  border-radius:10px;padding:0.45rem 0.85rem;font-size:0.78rem;font-weight:800;
  cursor:pointer;font-family:'Poppins',sans-serif;flex-shrink:0}
.cancel-btn:active{opacity:0.8}
.cancel-expired-txt{font-size:0.72rem;opacity:0.65;font-weight:600}

/* ‚îÄ‚îÄ Order cards ‚îÄ‚îÄ */
.order-card{background:#fff;border-radius:16px;margin-bottom:0.75rem;overflow:hidden;
  box-shadow:0 2px 8px rgba(0,0,0,0.06)}
.order-header{display:flex;justify-content:space-between;align-items:center;
  padding:0.9rem 1rem 0.5rem}
.order-id{font-size:0.85rem;font-weight:700}
.order-date{font-size:0.72rem;color:#999}
.order-items{padding:0 1rem 0.5rem;font-size:0.82rem;color:#555;line-height:1.6}
.order-footer{display:flex;justify-content:space-between;align-items:center;
  padding:0.6rem 1rem 0.9rem;border-top:1px solid #F5F5F5}
.order-total{font-size:0.95rem;font-weight:700}
.badge{display:inline-block;padding:0.25rem 0.7rem;border-radius:20px;
  font-size:0.72rem;font-weight:600}
.badge-pending{background:#FFF3E0;color:#E65100}
.badge-confirmed{background:#E3F2FD;color:#1565C0}
.badge-cooking{background:#F3E5F5;color:#6A1B9A}
.badge-delivering{background:#E8F5E9;color:#2E7D32}
.badge-done{background:#E8F5E9;color:#1B5E20}
.badge-cancelled{background:#FFEBEE;color:#C62828}

/* ‚îÄ‚îÄ Contact box ‚îÄ‚îÄ */
.contact-box{background:#fff;border-radius:16px;padding:1rem 1.1rem;
  display:flex;align-items:center;gap:0.75rem;
  box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:0.75rem}
.contact-icon{font-size:1.4rem}
.contact-info{flex:1}
.contact-label{font-size:0.7rem;color:#999;font-weight:600}
.contact-phone{font-size:0.95rem;font-weight:800;color:#202124}
.contact-call{background:#FAB95B;color:#fff;border:none;border-radius:10px;
  padding:0.5rem 0.9rem;font-size:0.8rem;font-weight:700;cursor:pointer;
  font-family:'Poppins',sans-serif;flex-shrink:0}

/* ‚îÄ‚îÄ Empty ‚îÄ‚îÄ */
.empty-state{display:flex;flex-direction:column;align-items:center;
  justify-content:center;padding:4rem 2rem;gap:1rem;text-align:center}
.empty-icon{font-size:3.5rem}
.empty-state p{font-size:0.95rem;color:#999}
</style>
</head>
<body>

<header class="page-header">
  <button class="back-btn" onclick="history.back()">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#202124" stroke-width="2.5">
      <path d="M15 18l-6-6 6-6"/>
    </svg>
  </button>

  <h1 class="page-title" id="pageTitle">Buyurtmalarim</h1>

  <span class="coin-pill" id="headerCoinPill" style="display:none;">
    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 36 36'%3E%3Ccircle cx='18' cy='18' r='18' fill='%23F5A53A'/%3E%3Ccircle cx='18' cy='18' r='14' fill='%23FAB95B'/%3E%3Ccircle cx='18' cy='18' r='10' fill='%23FDD07A'/%3E%3Ctext x='18' y='23' text-anchor='middle' font-size='13' font-weight='bold' fill='%23A0610A'%3E%E2%82%BF%3C/text%3E%3C/svg%3E" alt="">
    <span id="headerCoinCount">0</span>
  </span>

  <!-- ‚úÖ FIX: data:image emas, UZ/RU -->
  <span class="lang-flag" id="headerFlag" onclick="toggleLang()"></span>
</header>

<div class="content" id="content"></div>

<script>
const TX = {
  uz:{
    pageTitle:"Buyurtmalarim",
    noOrders:"Hali buyurtma yo'q",
    activeOrder:"Faol buyurtma",
    cancelLabel:"Bekor qilish imkoni",
    cancelHint:"Bekor qilish",
    cancelBtn:"Bekor qilish",
    cancelExpired:"Muddati o'tdi",
    contactLabel:"Muammo bo'lsa bog'laning",
    stepPending:"Qabul qilindi",
    stepConfirmed:"Tasdiqlandi",
    stepCooking:"Tayyorlanmoqda",
    stepDelivering:"Yetkazilmoqda",
    stepDone:"Yetkazildi",
    statusPending:"Kutilmoqda",
    statusConfirmed:"Tasdiqlandi",
    statusCooking:"Tayyorlanmoqda",
    statusDelivering:"Yo'lda",
    statusDone:"Yetkazildi",
    statusCancelled:"Bekor qilindi",
  },
  ru:{
    pageTitle:"–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤",
    noOrders:"–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤",
    activeOrder:"–ê–∫—Ç–∏–≤–Ω—ã–π –∑–∞–∫–∞–∑",
    cancelLabel:"–ú–æ–∂–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å",
    cancelHint:"–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑",
    cancelBtn:"–û—Ç–º–µ–Ω–∏—Ç—å",
    cancelExpired:"–í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ",
    contactLabel:"–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ ‚Äî –∑–≤–æ–Ω–∏—Ç–µ",
    stepPending:"–ü—Ä–∏–Ω—è—Ç",
    stepConfirmed:"–ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω",
    stepCooking:"–ì–æ—Ç–æ–≤–∏—Ç—Å—è",
    stepDelivering:"–í–µ–∑—É—Ç",
    stepDone:"–î–æ—Å—Ç–∞–≤–ª–µ–Ω",
    statusPending:"–û–∂–∏–¥–∞–µ—Ç—Å—è",
    statusConfirmed:"–ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω",
    statusCooking:"–ì–æ—Ç–æ–≤–∏—Ç—Å—è",
    statusDelivering:"–í –ø—É—Ç–∏",
    statusDone:"–î–æ—Å—Ç–∞–≤–ª–µ–Ω",
    statusCancelled:"–û—Ç–º–µ–Ω—ë–Ω",
  }
};

// ‚úÖ LANG normalize
let lang = (() => {
  const v = (localStorage.getItem('kfc_lang') || 'uz').trim().toLowerCase();
  return (v === 'uz' || v === 'ru') ? v : 'uz';
})();
function t(k){ return (TX[lang] && TX[lang][k]) ? TX[lang][k] : k; }

function toggleLang(){
  lang = (lang === 'uz') ? 'ru' : 'uz';
  localStorage.setItem('kfc_lang', lang);
  render();
}

function getUser(){
  try{ return JSON.parse(localStorage.getItem('kfc_user')||'null'); }catch{ return null; }
}

function cacheKey(){
  const u = getUser();
  return u?.phone ? 'kfc_orders_' + u.phone.replace(/[^0-9]/g,'') : 'kfc_orders_guest';
}
function getOrders(){
  try{ return JSON.parse(localStorage.getItem(cacheKey())||'[]'); }catch{return[];}
}
function saveOrders(orders){
  localStorage.setItem(cacheKey(), JSON.stringify(orders));
}

const API_URL = 'https://web-production-5aab6.up.railway.app';
let statusPollInterval = null;

async function fetchOrdersByPhone(){
  const user = getUser();
  if(!user || !user.phone) return null;
  try{
    const res = await fetch(`${API_URL}/api/orders?phone=${encodeURIComponent(user.phone)}&limit=50`);
    if(!res.ok) return null;
    const data = await res.json();
    return data.orders || [];
  } catch(e){ return null; }
}

async function loadCoinBalance(){
  const user = getUser();
  if(!user || !user.phone) return 0;
  try{
    const res = await fetch(`${API_URL}/api/coins?phone=${encodeURIComponent(user.phone)}`);
    if(!res.ok) return 0;
    const data = await res.json();
    return data.balance || 0;
  } catch(e){ return 0; }
}

const STEPS = ['pending','confirmed','cooking','delivering','done'];
const STEP_ICONS = [
  '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>',
  '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>',
  '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>',
  '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13" rx="2" ry="2"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>',
  '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>'
];
const CHECK_ICON = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';

function stepIndex(status){
  const idx = STEPS.indexOf(status);
  return idx < 0 ? 0 : idx;
}
function badgeClass(status){
  const map = {
    pending:'badge-pending', confirmed:'badge-confirmed',
    cooking:'badge-cooking', delivering:'badge-delivering',
    done:'badge-done', cancelled:'badge-cancelled'
  };
  return map[status]||'badge-pending';
}

async function syncOrderStatus(orderId){
  try {
    const res = await fetch(`${API_URL}/api/orders/${orderId}`);
    if(!res.ok) return;
    const data = await res.json();
    const orders = getOrders();
    const idx = orders.findIndex(o=>o.id==orderId);
    if(idx!==-1 && orders[idx].status !== data.status){
      orders[idx].status = data.status;
      saveOrders(orders);
      render();
    }
  } catch(e){}
}

function startPolling(orderId){
  if(statusPollInterval) clearInterval(statusPollInterval);
  statusPollInterval = setInterval(()=>{ syncOrderStatus(orderId); }, 5000);
}
function stopPolling(){
  if(statusPollInterval){ clearInterval(statusPollInterval); statusPollInterval = null; }
}

// ‚îÄ‚îÄ Active order timer ‚îÄ‚îÄ
let timerInterval = null;

function renderActiveBanner(order){
  const stored = localStorage.getItem('kfc_order_timestamp_' + order.id);
  const orderTs = stored ? Number(stored) : (order.timestamp ? Number(order.timestamp) : Date.now());

  const elapsed = Math.floor((Date.now() - orderTs) / 1000);
  const remaining = Math.max(0, 60 - elapsed);
  const canCancel = remaining > 0 && order.status === 'pending';
  const si = stepIndex(order.status);

  const stepsHtml = STEPS.slice(0,5).map((s,i)=>{
    const isDone   = i < si;
    const isActive = i === si;
    const dotClass = isDone?'done':(isActive?'active':'');
    const lineClass= isDone?'done':'';
    return `
      <div class="step">
        <div style="position:relative;width:100%">
          ${i<4?`<div class="step-line ${lineClass}"></div>`:''}
          <div class="step-dot ${dotClass}">${isDone?CHECK_ICON:STEP_ICONS[i]}</div>
        </div>
        <span class="step-label">${t('step'+s.charAt(0).toUpperCase()+s.slice(1))}</span>
      </div>`;
  }).join('');

  const cancelHtml = canCancel ? `
    <div class="cancel-wrap">
      <div class="cancel-ring">
        <svg width="40" height="40" viewBox="0 0 40 40">
          <circle class="bg" cx="20" cy="20" r="18"/>
          <circle class="prog" id="progCircle" cx="20" cy="20" r="18"/>
        </svg>
        <div class="num" id="cancelNum">${remaining}</div>
      </div>
      <div class="cancel-info">
        <div class="ci-label">${t('cancelLabel')}</div>
        <div class="ci-hint">${t('cancelHint')}</div>
      </div>
      <button class="cancel-btn" onclick="cancelOrder('${order.id}')">${t('cancelBtn')}</button>
    </div>` : (order.status==='pending' ? `
    <div class="cancel-wrap">
      <div class="cancel-info">
        <span class="cancel-expired-txt">${t('cancelExpired')}</span>
      </div>
    </div>` : '');

  const html = `
    <div class="active-order-banner">
      <div class="aob-top">
        <div>
          <div class="aob-label">${t('activeOrder')}</div>
          <div class="aob-id">#${order.id}</div>
        </div>
        <div class="aob-status">${t('status'+order.status.charAt(0).toUpperCase()+order.status.slice(1))}</div>
      </div>
      <div class="aob-steps">${stepsHtml}</div>
      ${cancelHtml}
    </div>`;

  if (canCancel){
    if(timerInterval) clearInterval(timerInterval);

    function tickCancel(){
      const elapsedNow = Math.floor((Date.now() - orderTs) / 1000);
      const secsLeft = Math.max(0, 60 - elapsedNow);
      const numEl = document.getElementById('cancelNum');
      const prog  = document.getElementById('progCircle');
      if(numEl) numEl.textContent = secsLeft;
      if(prog)  prog.style.strokeDashoffset = 113*(1-secsLeft/60);
      if(secsLeft <= 0){
        clearInterval(timerInterval);
        timerInterval = null;
        render();
      }
    }
    tickCancel();
    timerInterval = setInterval(tickCancel, 1000);
  }

  return html;
}

async function cancelOrder(orderId){
  if(timerInterval) clearInterval(timerInterval);
  stopPolling();

  try { await fetch(`${API_URL}/api/orders/${orderId}/cancel`, { method: 'PATCH' }); } catch(e){}

  const orders = getOrders();
  const idx = orders.findIndex(o=>o.id==orderId);
  if(idx!==-1){
    orders[idx].status = 'cancelled';
    saveOrders(orders);
  }
  render();
}

function render(){
  document.getElementById('pageTitle').textContent = t('pageTitle');

  // ‚úÖ FIX: header flag text
  const headerFlag = document.getElementById('headerFlag');
  if(headerFlag) headerFlag.textContent = (lang === 'uz') ? 'UZ' : 'RU';

  const orders = getOrders();
  const el = document.getElementById('content');

  if(!orders.length){
    el.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">üì¶</div>
        <p>${t('noOrders')}</p>
      </div>`;
    stopPolling();
    return;
  }

  const reversed = orders.slice().reverse();
  const activeOrder = reversed.find(o=>o.status!=='done'&&o.status!=='cancelled');

  let html = '';

  if(activeOrder){
    html += renderActiveBanner(activeOrder);
    startPolling(activeOrder.id);
  } else {
    stopPolling();
  }

  html += `
    <div class="contact-box">
      <div class="contact-icon">üìû</div>
      <div class="contact-info">
        <div class="contact-label">${t('contactLabel')}</div>
        <div class="contact-phone">+998 71 001 00 01</div>
      </div>
      <button class="contact-call" onclick="window.location.href='tel:+998710010001'">${lang==='ru'?'–ü–æ–∑–≤–æ–Ω–∏—Ç—å':'Qo\\'ng\\'iroq'}</button>
    </div>`;

  html += reversed.map(o=>{
    const statusKey = 'status'+o.status.charAt(0).toUpperCase()+o.status.slice(1);
    const itemsText = (o.items||[]).map(i=>`${i.fullName||i.name} √ó ${i.quantity||i.qty||1}`).join('<br>');
    return `
      <div class="order-card">
        <div class="order-header">
          <span class="order-id">#${o.id}</span>
          <span class="order-date">${o.date || ''}</span>
        </div>
        <div class="order-items">${itemsText || ''}</div>
        <div class="order-footer">
          <span class="order-total">${Number(o.total||0).toLocaleString()} UZS</span>
          <span class="badge ${badgeClass(o.status)}">${t(statusKey)}</span>
        </div>
      </div>`;
  }).join('');

  el.innerHTML = html;
}

document.addEventListener('DOMContentLoaded', async ()=>{
  const user = getUser();
  const el = document.getElementById('content');

  if(!user || !user.phone){
    el.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">üë§</div>
        <p>Buyurtmalarni ko'rish uchun avval ro'yxatdan o'ting</p>
      </div>`;
    return;
  }

  el.innerHTML = `<div style="text-align:center;padding:3rem;color:#999;font-size:0.95rem;">‚è≥ Yuklanmoqda...</div>`;

  const backendOrders = await fetchOrdersByPhone();

  if(backendOrders !== null){
    const normalized = backendOrders.map(bo => {
      // ‚úÖ FIX: created_at asosida real timestamp
      const createdTs = bo.created_at
        ? new Date(bo.created_at).getTime()
        : (bo.timestamp ? Number(bo.timestamp) : Date.now());

      // ‚úÖ FIX: per-order timestamp 1 marta yoziladi
      const tsKey = 'kfc_order_timestamp_' + bo.id;
      if (!localStorage.getItem(tsKey)) {
        localStorage.setItem(tsKey, String(createdTs));
      }

      return {
        id: bo.id,
        date: bo.date || new Date(createdTs).toLocaleDateString(lang === 'ru' ? 'ru-RU' : 'uz-UZ'),
        timestamp: createdTs,
        items: bo.items || [],
        address: bo.address || '',
        total: Number(bo.total || 0),
        status: bo.status,
        phone: bo.phone
      };
    });

    saveOrders(normalized);
  }

  // coin pill
  const bal = await loadCoinBalance();
  const pill = document.getElementById('headerCoinPill');
  const cnt  = document.getElementById('headerCoinCount');
  if(pill && cnt){ cnt.textContent = bal || 0; pill.style.display = 'inline-flex'; }

  render();

  const orders = getOrders();
  const active = orders.slice().reverse().find(o=>o.status!=='done'&&o.status!=='cancelled');
  if(active) startPolling(active.id);
});
</script>
</body>
</html>
