<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="theme-color" content="#FFFFFF">
<title>Buyurtmalar</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap');
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'Poppins',-apple-system,sans-serif;background:#F5F5F5;color:#202124;min-height:100vh;min-height:100dvh;-webkit-overflow-scrolling:touch;}

.page-header{background:#fff;padding:calc(env(safe-area-inset-top,0px) + 0.75rem) 1rem 0.8rem;position:sticky;top:0;z-index:100;
  display:flex;align-items:center;gap:0.75rem;box-shadow:0 2px 8px rgba(0,0,0,0.05)}
.back-btn{background:transparent;border:none;padding:0.4rem;cursor:pointer;
  display:flex;align-items:center;justify-content:center;border-radius:50%;flex-shrink:0}
.back-btn:active{background:#F5F5F5}
.page-title{font-size:1.1rem;font-weight:700;flex:1}
.lang-flag{width:38px;height:38px;border-radius:50%;overflow:hidden;cursor:pointer;flex-shrink:0}
.lang-flag img{width:100%;height:100%;object-fit:cover;transform:scale(1.12);display:block}

.content{padding:1rem;padding-bottom:calc(env(safe-area-inset-bottom,0px) + 1rem)}

/* ── Coin pill ── */
.coin-pill{display:inline-flex;align-items:center;gap:0.35rem;
  background:#fff;border:1.5px solid #E8E8E8;border-radius:20px;
  padding:0.28rem 0.65rem;font-size:0.82rem;font-weight:800;color:#202124;
  box-shadow:0 1px 4px rgba(0,0,0,0.08);}
.coin-pill img{width:18px;height:18px;}

/* ── Active order banner ── */
.active-order-banner{
  background:linear-gradient(135deg,#FAB95B,#B71C1C);
  border-radius:18px;padding:1.1rem 1.1rem 1.25rem;
  margin-bottom:1rem;color:#fff;position:relative;overflow:hidden}
.active-order-banner::before{
  content:'';position:absolute;width:180px;height:180px;
  background:rgba(255,255,255,0.07);border-radius:50%;
  top:-60px;right:-50px}
.aob-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:0.75rem}
.aob-label{font-size:0.7rem;font-weight:700;opacity:0.75;text-transform:uppercase;letter-spacing:0.5px}
.aob-id{font-size:1rem;font-weight:800}
.aob-status{font-size:0.78rem;font-weight:700;background:rgba(255,255,255,0.2);
  border-radius:20px;padding:0.25rem 0.7rem}
.aob-steps{display:flex;align-items:center;gap:0;margin-bottom:1rem}
.step{display:flex;flex-direction:column;align-items:center;flex:1;position:relative}
.step-dot{width:28px;height:28px;border-radius:50%;background:rgba(255,255,255,0.25);
  display:flex;align-items:center;justify-content:center;font-size:0.95rem;
  border:2px solid rgba(255,255,255,0.4);position:relative;z-index:1}
.step-dot.done{background:rgba(255,255,255,0.9);border-color:transparent}
.step-dot.active{background:#fff;border-color:#fff;
  box-shadow:0 0 0 4px rgba(255,255,255,0.25)}
.step-line{position:absolute;top:14px;left:50%;width:100%;height:2px;
  background:rgba(255,255,255,0.25);z-index:0}
.step-line.done{background:rgba(255,255,255,0.7)}
.step-label{font-size:0.6rem;font-weight:600;opacity:0.8;margin-top:0.3rem;text-align:center;
  white-space:nowrap}

/* ── 1-min cancel timer ── */
.cancel-wrap{display:flex;align-items:center;gap:0.75rem;
  background:rgba(0,0,0,0.15);border-radius:12px;padding:0.7rem 0.9rem}
.cancel-ring{position:relative;width:40px;height:40px;flex-shrink:0}
.cancel-ring svg{transform:rotate(-90deg)}
.cancel-ring circle.bg{fill:none;stroke:rgba(255,255,255,0.2);stroke-width:4}
.cancel-ring circle.prog{fill:none;stroke:#fff;stroke-width:4;stroke-linecap:round;
  stroke-dasharray:113;stroke-dashoffset:0;transition:stroke-dashoffset 1s linear}
.cancel-ring .num{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  font-size:0.78rem;font-weight:800;color:#fff}
.cancel-info{flex:1}
.cancel-info .ci-label{font-size:0.7rem;opacity:0.75;font-weight:600}
.cancel-info .ci-hint{font-size:0.78rem;font-weight:700}
.cancel-btn{background:rgba(255,255,255,0.95);color:#FAB95B;border:none;
  border-radius:10px;padding:0.45rem 0.85rem;font-size:0.78rem;font-weight:800;
  cursor:pointer;font-family:'Poppins',sans-serif;flex-shrink:0}
.cancel-btn:active{opacity:0.8}
.cancel-expired-txt{font-size:0.72rem;opacity:0.65;font-weight:600}

/* ── Order cards ── */
.order-card{background:#fff;border-radius:16px;margin-bottom:0.75rem;overflow:hidden;
  box-shadow:0 2px 8px rgba(0,0,0,0.06)}
.order-header{display:flex;justify-content:space-between;align-items:center;
  padding:0.9rem 1rem 0.5rem}
.order-id{font-size:0.85rem;font-weight:700}
.order-date{font-size:0.72rem;color:#999}
.order-items{padding:0 1rem 0.5rem;font-size:0.82rem;color:#555;line-height:1.6}
.order-footer{display:flex;justify-content:space-between;align-items:center;
  padding:0.6rem 1rem 0.9rem;border-top:1px solid #F5F5F5}
.order-total{font-size:0.95rem;font-weight:700}
.badge{display:inline-block;padding:0.25rem 0.7rem;border-radius:20px;
  font-size:0.72rem;font-weight:600}
.badge-pending{background:#FFF3E0;color:#E65100}
.badge-confirmed{background:#E3F2FD;color:#1565C0}
.badge-cooking{background:#F3E5F5;color:#6A1B9A}
.badge-delivering{background:#E8F5E9;color:#2E7D32}
.badge-done{background:#E8F5E9;color:#1B5E20}
.badge-cancelled{background:#FFEBEE;color:#C62828}

/* ── Contact box ── */
.contact-box{background:#fff;border-radius:16px;padding:1rem 1.1rem;
  display:flex;align-items:center;gap:0.75rem;
  box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:0.75rem}
.contact-icon{font-size:1.4rem}
.contact-info{flex:1}
.contact-label{font-size:0.7rem;color:#999;font-weight:600}
.contact-phone{font-size:0.95rem;font-weight:800;color:#202124}
.contact-call{background:#FAB95B;color:#fff;border:none;border-radius:10px;
  padding:0.5rem 0.9rem;font-size:0.8rem;font-weight:700;cursor:pointer;
  font-family:'Poppins',sans-serif;flex-shrink:0}

/* ── Empty ── */
.empty-state{display:flex;flex-direction:column;align-items:center;
  justify-content:center;padding:4rem 2rem;gap:1rem;text-align:center}
.empty-icon{font-size:3.5rem}
.empty-state p{font-size:0.95rem;color:#999}
</style>
</head>
<body>

<header class="page-header">
  <button class="back-btn" onclick="history.back()">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#202124" stroke-width="2.5">
      <path d="M15 18l-6-6 6-6"/>
    </svg>
  </button>
  <h1 class="page-title" id="pageTitle">Buyurtmalarim</h1>

  <span class="coin-pill" id="headerCoinPill" style="display:none;">
    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 36 36'%3E%3Ccircle cx='18' cy='18' r='18' fill='%23F5A53A'/%3E%3Ccircle cx='18' cy='18' r='14' fill='%23FAB95B'/%3E%3Ccircle cx='18' cy='18' r='10' fill='%23FDD07A'/%3E%3Ctext x='18' y='23' text-anchor='middle' font-size='13' font-weight='bold' fill='%23A0610A'%3E%E2%82%BF%3C/text%3E%3C/svg%3E" alt="">
    <span id="headerCoinCount">0</span>
  </span>

  <span class="lang-flag" id="headerFlag" onclick="toggleLang()"></span>
</header>

<div class="content" id="content"></div>

<script>
const FLAG_IMGS = { uz:'data:image/png;base64,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', ru:'data:image/png;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/4gHYSUNDX1BST0ZJTEUAAQEAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADb/2wBDAAUDBAQEAwUEBAQFBQUGBwwIBwcHBw8LCwkMEQ8SEhEPERETFhwXExQaFRERGCEYGh0dHx8fExciJCIeJBweHx7/2wBDAQUFBQcGBw4ICA4eFBEUHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh7/wAARCABkAKADASIAAhEBAxEB/8QAGgABAAMBAQEAAAAAAAAAAAAAAAMEBQIBBv/EADEQAAIBAwMCBAUEAgMAAAAAAAABAgMEESExBRJBUWETInGBkTIUI0KhsRUkUsH/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/8QAFBEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEQMRAD8A+4gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/9k=' };

const TX = {
  uz:{
    pageTitle:"Buyurtmalarim",
    noOrders:"Hali buyurtma yo'q",
    activeOrder:"Faol buyurtma",
    cancelLabel:"Bekor qilish imkoni",
    cancelHint:"Bekor qilish",
    cancelBtn:"Bekor qilish",
    cancelExpired:"Muddati o'tdi",
    contactLabel:"Muammo bo'lsa bog'laning",
    stepPending:"Qabul qilindi",
    stepConfirmed:"Tasdiqlandi",
    stepCooking:"Tayyorlanmoqda",
    stepDelivering:"Yetkazilmoqda",
    stepDone:"Yetkazildi",
    statusPending:"Kutilmoqda",
    statusConfirmed:"Tasdiqlandi",
    statusCooking:"Tayyorlanmoqda",
    statusDelivering:"Yo'lda",
    statusDone:"Yetkazildi",
    statusCancelled:"Bekor qilindi",
    orderId:"Buyurtma",
    orderTotal:"Jami",
  },
  ru:{
    pageTitle:"История заказов",
    noOrders:"У вас пока нет заказов",
    activeOrder:"Активный заказ",
    cancelLabel:"Можно отменить",
    cancelHint:"Отменить заказ",
    cancelBtn:"Отменить",
    cancelExpired:"Время истекло",
    contactLabel:"Если проблема — звоните",
    stepPending:"Принят",
    stepConfirmed:"Подтверждён",
    stepCooking:"Готовится",
    stepDelivering:"Везут",
    stepDone:"Доставлен",
    statusPending:"Ожидается",
    statusConfirmed:"Подтверждён",
    statusCooking:"Готовится",
    statusDelivering:"В пути",
    statusDone:"Доставлен",
    statusCancelled:"Отменён",
    orderId:"Заказ",
    orderTotal:"Итого",
  }
};

// ✅ LANG normalize (flag ishlamasligi shu sabab bo'lishi mumkin)
let lang = (() => {
  const v = (localStorage.getItem('kfc_lang') || 'uz').trim().toLowerCase();
  return (v === 'uz' || v === 'ru') ? v : 'uz';
})();

function t(k){ return (TX[lang] && TX[lang][k]) ? TX[lang][k] : k; }

function toggleLang(){
  lang = (lang === 'uz') ? 'ru' : 'uz';
  localStorage.setItem('kfc_lang', lang);
  render();
}

window.addEventListener('storage', e=>{
  if(e.key==='kfc_lang'){
    const v = (e.newValue || 'uz').trim().toLowerCase();
    lang = (v === 'uz' || v === 'ru') ? v : 'uz';
    render();
  }
});

function getUser(){
  try{ return JSON.parse(localStorage.getItem('kfc_user')||'null'); }catch{ return null; }
}

function cacheKey(){
  const u = getUser();
  return u?.phone ? 'kfc_orders_' + u.phone.replace(/[^0-9]/g,'') : 'kfc_orders_guest';
}

function getOrders(){
  try{ return JSON.parse(localStorage.getItem(cacheKey())||'[]'); }catch{return[];}
}
function saveOrders(orders){
  localStorage.setItem(cacheKey(), JSON.stringify(orders));
}

async function fetchOrdersByPhone(){
  const user = getUser();
  if(!user || !user.phone) return null;
  try{
    const res = await fetch(`${API_URL}/api/orders?phone=${encodeURIComponent(user.phone)}&limit=50`);
    if(!res.ok) return null;
    const data = await res.json();
    return data.orders || [];
  } catch(e){ return null; }
}

const STEPS = ['pending','confirmed','cooking','delivering','done'];
const STEP_ICONS = [
  '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>',
  '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>',
  '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>',
  '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13" rx="2" ry="2"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>',
  '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>'
];
const CHECK_ICON = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';

const API_URL = 'https://web-production-5aab6.up.railway.app';
let statusPollInterval = null;

async function loadCoinBalance(){
  const user = getUser();
  if(!user || !user.phone) return 0;
  try{
    const res = await fetch(`${API_URL}/api/coins?phone=${encodeURIComponent(user.phone)}`);
    if(!res.ok) return 0;
    const data = await res.json();
    return data.balance || 0;
  } catch(e){ return 0; }
}

function stepIndex(status){
  const idx = STEPS.indexOf(status);
  return idx < 0 ? 0 : idx;
}

function badgeClass(status){
  const map = {
    pending:'badge-pending', confirmed:'badge-confirmed',
    cooking:'badge-cooking', delivering:'badge-delivering',
    done:'badge-done', cancelled:'badge-cancelled'
  };
  return map[status]||'badge-pending';
}

async function syncOrderStatus(orderId){
  try {
    const res = await fetch(`${API_URL}/api/orders/${orderId}`);
    if(!res.ok) return;
    const data = await res.json();

    const orders = getOrders();
    const idx = orders.findIndex(o=>o.id==orderId);
    if(idx!==-1 && orders[idx].status !== data.status){
      orders[idx].status = data.status;
      saveOrders(orders);
      render();
    }
  } catch(e){}
}

function startPolling(orderId){
  if(statusPollInterval) clearInterval(statusPollInterval);
  statusPollInterval = setInterval(()=>{ syncOrderStatus(orderId); }, 5000);
}

function stopPolling(){
  if(statusPollInterval){ clearInterval(statusPollInterval); statusPollInterval = null; }
}

// ── Active order with timer ──
let timerInterval = null;

function renderActiveBanner(order){
  const now = Date.now();

  // ✅ real timestamp (localStorage -> order.timestamp -> now)
  const stored = localStorage.getItem('kfc_order_timestamp_' + order.id);
  const orderTs = stored ? Number(stored) : (order.timestamp ? Number(order.timestamp) : Date.now());

  const elapsed = Math.floor((now - orderTs) / 1000);
  const remaining = Math.max(0, 60 - elapsed);
  const canCancel = remaining > 0 && order.status === 'pending';
  const si = stepIndex(order.status);

  const stepsHtml = STEPS.slice(0,5).map((s,i)=>{
    const isDone   = i < si;
    const isActive = i === si;
    const dotClass = isDone?'done':(isActive?'active':'');
    const lineClass= isDone?'done':'';
    return `
      <div class="step">
        <div style="position:relative;width:100%">
          ${i<4?`<div class="step-line ${lineClass}"></div>`:''}
          <div class="step-dot ${dotClass}">${isDone?CHECK_ICON:STEP_ICONS[i]}</div>
        </div>
        <span class="step-label">${t('step'+s.charAt(0).toUpperCase()+s.slice(1))}</span>
      </div>`;
  }).join('');

  const cancelHtml = canCancel ? `
    <div class="cancel-wrap" id="cancelWrap">
      <div class="cancel-ring">
        <svg width="40" height="40" viewBox="0 0 40 40">
          <circle class="bg" cx="20" cy="20" r="18"/>
          <circle class="prog" id="progCircle" cx="20" cy="20" r="18"/>
        </svg>
        <div class="num" id="cancelNum">${remaining}</div>
      </div>
      <div class="cancel-info">
        <div class="ci-label">${t('cancelLabel')}</div>
        <div class="ci-hint">${t('cancelHint')}</div>
      </div>
      <button class="cancel-btn" onclick="cancelOrder('${order.id}')">${t('cancelBtn')}</button>
    </div>` : (order.status==='pending' ? `
    <div class="cancel-wrap">
      <div class="cancel-info">
        <span class="cancel-expired-txt">${t('cancelExpired')}</span>
      </div>
    </div>` : '');

  const html = `
    <div class="active-order-banner">
      <div class="aob-top">
        <div>
          <div class="aob-label">${t('activeOrder')}</div>
          <div class="aob-id">#${order.id.toString()}</div>
        </div>
        <div class="aob-status">${t('status'+order.status.charAt(0).toUpperCase()+order.status.slice(1))}</div>
      </div>
      <div class="aob-steps">${stepsHtml}</div>
      ${cancelHtml}
    </div>`;

  if (canCancel){
    if(timerInterval) clearInterval(timerInterval);

    function tickCancel(){
      const nowTs = Date.now();
      const elapsedNow = Math.floor((nowTs - orderTs) / 1000);
      const secsLeft = Math.max(0, 60 - elapsedNow);
      const numEl = document.getElementById('cancelNum');
      const prog  = document.getElementById('progCircle');
      if(numEl) numEl.textContent = secsLeft;
      if(prog)  prog.style.strokeDashoffset = 113*(1-secsLeft/60);
      if(secsLeft <= 0){
        clearInterval(timerInterval);
        timerInterval = null;
        render();
      }
    }
    tickCancel();
    timerInterval = setInterval(tickCancel, 1000);
  }

  return html;
}

async function cancelOrder(orderId){
  if(timerInterval) clearInterval(timerInterval);
  stopPolling();

  try {
    await fetch(`${API_URL}/api/orders/${orderId}/cancel`, { method: 'PATCH' });
  } catch(e){}

  const orders = getOrders();
  const idx = orders.findIndex(o=>o.id==orderId);
  if(idx!==-1){
    orders[idx].status = 'cancelled';
    saveOrders(orders);
  }
  render();
}

function render(){
  document.getElementById('pageTitle').textContent = t('pageTitle');

  // ✅ flag fail-safe
  const flagSrc = FLAG_IMGS[lang] || FLAG_IMGS.uz;
  document.getElementById('headerFlag').innerHTML =
    `<img src="${flagSrc}" alt="${lang.toUpperCase()}"
          style="width:100%;height:100%;object-fit:cover;transform:scale(1.12);display:block">`;

  const orders = getOrders();
  const el = document.getElementById('content');

  if(!orders.length){
    el.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#DDD" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
        </div>
        <p>${t('noOrders')}</p>
      </div>`;
    stopPolling();
    return;
  }

  const reversed = orders.slice().reverse();
  const activeOrder = reversed.find(o=>o.status!=='done'&&o.status!=='cancelled');

  let html = '';

  if(activeOrder){
    html += renderActiveBanner(activeOrder);
    startPolling(activeOrder.id);
  } else {
    stopPolling();
  }

  html += `
    <div class="contact-box">
      <div class="contact-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
      </div>
      <div class="contact-info">
        <div class="contact-label">${t('contactLabel')}</div>
        <div class="contact-phone">+998 71 001 00 01</div>
      </div>
      <button class="contact-call" onclick="window.location.href='tel:+998710010001'">Qo'ng'iroq</button>
    </div>`;

  html += reversed.map(o=>{
    const statusKey = 'status'+o.status.charAt(0).toUpperCase()+o.status.slice(1);
    const itemsText = (o.items||[]).map(i=>`${i.fullName||i.name} × ${i.quantity||i.qty||1}`).join('<br>');
    return `
      <div class="order-card">
        <div class="order-header">
          <span class="order-id">#${o.id}</span>
          <span class="order-date">${o.date || ''}</span>
        </div>
        <div class="order-items">${itemsText || ''}</div>
        <div class="order-footer">
          <span class="order-total">${Number(o.total||0).toLocaleString()} UZS</span>
          <span class="badge ${badgeClass(o.status)}">${t(statusKey)}</span>
        </div>
      </div>`;
  }).join('');

  el.innerHTML = html;
}

document.addEventListener('DOMContentLoaded', async ()=>{
  const user = getUser();
  const el = document.getElementById('content');

  if(!user || !user.phone){
    el.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#DDD" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
        </div>
        <p>Buyurtmalarni ko'rish uchun avval ro'yxatdan o'ting</p>
        <button onclick="window.location.href='register.html'"
          style="margin-top:1rem;padding:0.75rem 1.5rem;background:#FAB95B;color:#fff;
                 border:none;border-radius:12px;font-size:0.95rem;font-weight:700;cursor:pointer;">
          Ro'yxatdan o'tish
        </button>
      </div>`;
    return;
  }

  el.innerHTML = `<div style="text-align:center;padding:3rem;color:#999;font-size:0.95rem;">⏳ Yuklanmoqda...</div>`;

  const backendOrders = await fetchOrdersByPhone();

  if(backendOrders !== null){
    const normalized = backendOrders.map(bo => {
      const createdTs = bo.created_at
        ? new Date(bo.created_at).getTime()
        : (bo.timestamp ? Number(bo.timestamp) : Date.now());

      // cancel timer uchun per-order timestamp (1 marta)
      const tsKey = 'kfc_order_timestamp_' + bo.id;
      if (!localStorage.getItem(tsKey)) {
        localStorage.setItem(tsKey, String(createdTs));
      }

      return {
        id: bo.id,
        date: bo.date || new Date(createdTs).toLocaleDateString(lang === 'ru' ? 'ru-RU' : 'uz-UZ'),
        timestamp: createdTs,
        items: bo.items || [],
        address: bo.address || '',
        total: Number(bo.total || 0),
        status: bo.status,
        phone: bo.phone,
        payment: bo.payment || 'naqt',
        extra_phone: bo.extra_phone || null,
        comment: bo.comment || null,
      };
    });

    saveOrders(normalized);
  }

  window._coinBalance = await loadCoinBalance();
  const pill = document.getElementById('headerCoinPill');
  const cnt  = document.getElementById('headerCoinCount');
  if(pill && cnt){ cnt.textContent = window._coinBalance || 0; pill.style.display = 'inline-flex'; }

  render();

  const orders = getOrders();
  const active = orders.slice().reverse().find(o=>o.status!=='done'&&o.status!=='cancelled');
  if(active) startPolling(active.id);
});
</script>
</body>
</html>
