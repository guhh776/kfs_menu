<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>Ro'yxatdan o'tish</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #F5F5F5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .reg-header {
      background: linear-gradient(135deg, #FAB95B 0%, #F5A53A 100%);
      padding: 3rem 1.5rem 2rem;
      text-align: center;
      position: relative;
    }
    .reg-header::after {
      content: '';
      position: absolute;
      bottom: -20px; left: 50%;
      transform: translateX(-50%);
      width: 40px; height: 40px;
      background: #F5F5F5;
      border-radius: 50%;
    }
    .reg-logo { font-size: 3rem; margin-bottom: 0.75rem; }
    .reg-brand { font-size: 1.5rem; font-weight: 900; color: #fff; letter-spacing: -0.5px; }
    .reg-tagline { font-size: 0.85rem; color: rgba(255,255,255,0.85); margin-top: 0.25rem; }

    .reg-content {
      flex: 1;
      padding: 2.5rem 1.25rem 2rem;
      max-width: 480px;
      margin: 0 auto;
      width: 100%;
    }

    .steps {
      display: flex; align-items: center; justify-content: center;
      gap: 0; margin-bottom: 2rem;
    }
    .step-dot {
      width: 32px; height: 32px; border-radius: 50%;
      background: #E0E0E0; color: #999;
      font-size: 0.8rem; font-weight: 800;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.3s; flex-shrink: 0;
    }
    .step-dot.active { background: #FAB95B; color: #fff; box-shadow: 0 0 0 4px rgba(250,185,91,0.2); }
    .step-dot.done { background: #4CAF50; color: #fff; }
    .step-line { height: 2px; width: 40px; background: #E0E0E0; transition: background 0.3s; }
    .step-line.done { background: #4CAF50; }

    .reg-card {
      background: #fff; border-radius: 20px;
      padding: 1.75rem 1.25rem;
      box-shadow: 0 2px 16px rgba(0,0,0,0.06);
    }
    .card-icon { font-size: 2.5rem; text-align: center; margin-bottom: 0.75rem; }
    .card-title { font-size: 1.2rem; font-weight: 800; color: #202124; text-align: center; margin-bottom: 0.4rem; }
    .card-sub { font-size: 0.83rem; color: #888; text-align: center; margin-bottom: 1.5rem; line-height: 1.5; }

    /* Telegram bot instruksiya box */
    .tg-box {
      background: #E3F2FD;
      border-radius: 14px;
      padding: 1rem;
      margin-bottom: 1.25rem;
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
    }
    .tg-box-icon { font-size: 1.5rem; flex-shrink: 0; }
    .tg-box-text { font-size: 0.82rem; color: #1565C0; line-height: 1.6; }
    .tg-box-text b { display: block; margin-bottom: 0.25rem; font-size: 0.88rem; }
    .tg-link {
      display: inline-block;
      margin-top: 0.5rem;
      background: #2196F3;
      color: #fff;
      padding: 0.5rem 1rem;
      border-radius: 10px;
      font-size: 0.82rem;
      font-weight: 700;
      text-decoration: none;
    }

    .input-group { margin-bottom: 1rem; }
    .input-label {
      font-size: 0.78rem; font-weight: 700; color: #555;
      margin-bottom: 0.4rem; text-transform: uppercase; letter-spacing: 0.5px;
    }
    .input-wrap {
      display: flex; align-items: center;
      background: #F5F5F5; border-radius: 14px;
      border: 2px solid transparent; padding: 0 1rem;
      transition: all 0.2s;
    }
    .input-wrap:focus-within { border-color: #FAB95B; background: #fff; }
    .input-prefix { font-size: 1rem; font-weight: 700; color: #202124; flex-shrink: 0; margin-right: 0.3rem; }
    .input-wrap input, .single-input {
      flex: 1; border: none; background: transparent;
      font-size: 1rem; font-weight: 600; color: #202124;
      outline: none; padding: 0.85rem 0; width: 100%;
    }
    .single-input {
      background: #F5F5F5; border-radius: 14px;
      border: 2px solid transparent; padding: 0.85rem 1rem;
      transition: all 0.2s;
    }
    .single-input:focus { border-color: #FAB95B; background: #fff; outline: none; }

    .otp-wrap { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; }
    .otp-wrap input {
      flex: 1; padding: 1rem 0;
      border: 2px solid #E0E0E0; border-radius: 14px;
      font-size: 1.6rem; font-weight: 800;
      text-align: center; letter-spacing: 4px;
      outline: none; color: #202124;
      transition: border-color 0.2s; background: #F5F5F5;
    }
    .otp-wrap input:focus { border-color: #FAB95B; background: #fff; }

    .btn-primary {
      width: 100%; padding: 1rem;
      background: #FAB95B; color: #fff;
      border: none; border-radius: 14px;
      font-size: 1rem; font-weight: 800;
      cursor: pointer; transition: all 0.2s;
      margin-top: 0.5rem;
    }
    .btn-primary:active { transform: scale(0.98); opacity: 0.9; }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

    .error-msg {
      font-size: 0.8rem; color: #E53935;
      text-align: center; min-height: 1.1rem;
      margin: 0.4rem 0;
    }
    .success-msg {
      font-size: 0.82rem; color: #4CAF50;
      text-align: center; font-weight: 600;
      margin-bottom: 0.75rem;
    }
    .resend-btn {
      text-align: center; font-size: 0.82rem;
      color: #FAB95B; cursor: pointer;
      margin-top: 0.75rem; font-weight: 600;
      text-decoration: underline;
    }
    .timer-txt { text-align: center; font-size: 0.8rem; color: #999; margin-top: 0.5rem; }

    .step-panel { display: none; }
    .step-panel.active { display: block; }
  </style>
</head>
<body>

  <div class="reg-header">
    <div class="reg-logo">üçó</div>
    <div class="reg-brand">KFC Riston</div>
    <div class="reg-tagline">Tez va mazali taom yetkazish</div>
  </div>

  <div class="reg-content">
    <div class="steps">
      <div class="step-dot active" id="dot1">1</div>
      <div class="step-line" id="line1"></div>
      <div class="step-dot" id="dot2">2</div>
      <div class="step-line" id="line2"></div>
      <div class="step-dot" id="dot3">3</div>
    </div>

    <div class="reg-card">

      <!-- STEP 1: Telefon raqam -->
      <div class="step-panel active" id="step1">
        <div class="card-icon">üì±</div>
        <div class="card-title">Telefon raqamingiz</div>
        <div class="card-sub">Telegram orqali tasdiqlash kodi yuboriladi</div>

        <!-- Telegram instruksiya -->
        <div class="tg-box">
          <div class="tg-box-icon">üí°</div>
          <div class="tg-box-text">
            <b>Birinchi marta kirish uchun:</b>
            Telegram botga boring va <b>/start</b> tugmasini bosib, raqamingizni yuboring.
            <br>
            <a class="tg-link" href="https://t.me/YOUR_BOT_USERNAME" target="_blank">
              ‚úàÔ∏è Botga o'tish
            </a>
          </div>
        </div>

        <div class="input-group">
          <div class="input-label">Telefon raqam</div>
          <div class="input-wrap">
            <span class="input-prefix">+998</span>
            <input type="tel" id="phoneInput" placeholder="90 123 45 67"
              maxlength="12" inputmode="numeric"
              oninput="this.value=this.value.replace(/[^0-9 ]/g,'')"
              onkeydown="if(event.key==='Enter') sendOTP()">
          </div>
        </div>

        <div class="error-msg" id="err1"></div>
        <button class="btn-primary" id="sendBtn" onclick="sendOTP()">
          ‚úàÔ∏è Telegram ga kod yuborish
        </button>
      </div>

      <!-- STEP 2: OTP kod -->
      <div class="step-panel" id="step2">
        <div class="card-icon">üîê</div>
        <div class="card-title">Kodni kiriting</div>
        <div class="success-msg" id="otpSentMsg"></div>

        <div class="otp-wrap">
          <input type="tel" id="otpInput" placeholder="------"
            maxlength="6" inputmode="numeric"
            oninput="this.value=this.value.replace(/[^0-9]/g,''); if(this.value.length===6) verifyOTP()">
        </div>

        <div class="error-msg" id="err2"></div>
        <button class="btn-primary" id="verifyBtn" onclick="verifyOTP()">
          ‚úÖ Tasdiqlash
        </button>
        <div class="resend-btn" id="resendBtn" style="display:none" onclick="resendOTP()">
          Qaytadan kod yuborish
        </div>
        <div class="timer-txt" id="timerTxt"></div>
      </div>

      <!-- STEP 3: Ism familya -->
      <div class="step-panel" id="step3">
        <div class="card-icon">üë§</div>
        <div class="card-title">Ismingizni kiriting</div>
        <div class="card-sub">Bu ma'lumot buyurtma uchun ishlatiladi</div>

        <div class="input-group">
          <div class="input-label">Ism</div>
          <input type="text" class="single-input" id="firstName"
            placeholder="Masalan: Abdulloh" autocomplete="given-name"
            onkeydown="if(event.key==='Enter') document.getElementById('lastName').focus()">
        </div>
        <div class="input-group">
          <div class="input-label">Familya</div>
          <input type="text" class="single-input" id="lastName"
            placeholder="Masalan: Karimov" autocomplete="family-name"
            onkeydown="if(event.key==='Enter') saveProfile()">
        </div>

        <div class="error-msg" id="err3"></div>
        <button class="btn-primary" onclick="saveProfile()">
          ‚úÖ Tasdiqlash va boshlash
        </button>
      </div>

    </div>
  </div>

  <script>
    // ‚îÄ‚îÄ SOZLAMA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const API_URL = 'http://localhost:3000'; // production da serveringiz URL
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    let verifiedPhone = null;
    let resendTimer = null;

    function goStep(n) {
      document.querySelectorAll('.step-panel').forEach(p => p.classList.remove('active'));
      document.getElementById('step' + n).classList.add('active');
      for (let i = 1; i <= 3; i++) {
        const dot = document.getElementById('dot' + i);
        dot.classList.remove('active', 'done');
        if (i < n) { dot.classList.add('done'); dot.textContent = '‚úì'; }
        else if (i === n) dot.classList.add('active');
      }
      for (let i = 1; i <= 2; i++) {
        document.getElementById('line' + i).classList.toggle('done', i < n);
      }
    }

    function showErr(id, msg) { document.getElementById(id).textContent = msg; }
    function hideErr(id) { document.getElementById(id).textContent = ''; }

    function startResendTimer() {
      let secs = 60;
      const txt = document.getElementById('timerTxt');
      const btn = document.getElementById('resendBtn');
      btn.style.display = 'none';
      txt.textContent = `${secs} soniyadan keyin qayta yuborish`;
      resendTimer = setInterval(() => {
        secs--;
        if (secs <= 0) {
          clearInterval(resendTimer);
          txt.textContent = '';
          btn.style.display = 'block';
        } else {
          txt.textContent = `${secs} soniyadan keyin qayta yuborish`;
        }
      }, 1000);
    }

    window.sendOTP = async function() {
      const raw = document.getElementById('phoneInput').value.replace(/\D/g, '');
      if (raw.length < 9) { showErr('err1', "Telefon raqamni to'liq kiriting"); return; }
      const phone = '+998' + raw.slice(-9);

      hideErr('err1');
      const btn = document.getElementById('sendBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Yuborilmoqda...';

      try {
        const res = await fetch(`${API_URL}/api/otp/send`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone })
        });
        const data = await res.json();

        if (!res.ok) {
          if (data.error === 'not_registered') {
            showErr('err1', "Avval Telegram botga /start yuboring va raqamingizni tasdiqlang ‚òùÔ∏è");
          } else if (data.error === 'too_soon') {
            showErr('err1', "Biroz kuting va qayta urining");
          } else {
            showErr('err1', data.message || 'Xato yuz berdi');
          }
          btn.disabled = false;
          btn.textContent = '‚úàÔ∏è Telegram ga kod yuborish';
          return;
        }

        verifiedPhone = phone;
        document.getElementById('otpSentMsg').textContent =
          '‚úÖ Telegram ga kod yuborildi! Ilovangizni oching';
        document.getElementById('otpInput').value = '';
        goStep(2);
        startResendTimer();
        setTimeout(() => document.getElementById('otpInput').focus(), 300);

      } catch(e) {
        showErr('err1', 'Server bilan aloqa yo\'q. Backend ishlab turibdimi?');
        btn.disabled = false;
        btn.textContent = '‚úàÔ∏è Telegram ga kod yuborish';
      }
    };

    window.verifyOTP = async function() {
      const code = document.getElementById('otpInput').value.trim();
      if (code.length < 6) { showErr('err2', 'Kodni to\'liq kiriting (6 raqam)'); return; }

      hideErr('err2');
      const btn = document.getElementById('verifyBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Tekshirilmoqda...';

      try {
        const res = await fetch(`${API_URL}/api/otp/verify`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone: verifiedPhone, code })
        });
        const data = await res.json();

        if (!res.ok) {
          showErr('err2', data.message || "Noto'g'ri kod");
          btn.disabled = false;
          btn.textContent = '‚úÖ Tasdiqlash';
          return;
        }

        if (resendTimer) clearInterval(resendTimer);
        document.getElementById('firstName').value = '';
        document.getElementById('lastName').value = '';
        goStep(3);
        setTimeout(() => document.getElementById('firstName').focus(), 300);

      } catch(e) {
        showErr('err2', 'Server bilan aloqa yo\'q');
        btn.disabled = false;
        btn.textContent = '‚úÖ Tasdiqlash';
      }
    };

    window.resendOTP = async function() {
      document.getElementById('resendBtn').style.display = 'none';
      document.getElementById('timerTxt').textContent = '‚è≥ Yuborilmoqda...';
      document.getElementById('otpInput').value = '';
      hideErr('err2');

      try {
        const res = await fetch(`${API_URL}/api/otp/send`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone: verifiedPhone })
        });
        if (res.ok) {
          document.getElementById('otpSentMsg').textContent = '‚úÖ Yangi kod Telegram ga yuborildi!';
          startResendTimer();
        } else {
          const data = await res.json();
          document.getElementById('timerTxt').textContent = '';
          document.getElementById('resendBtn').style.display = 'block';
          showErr('err2', data.message || 'Xato. Qayta urining.');
        }
      } catch(e) {
        document.getElementById('timerTxt').textContent = '';
        document.getElementById('resendBtn').style.display = 'block';
        showErr('err2', 'Server bilan aloqa yo\'q');
      }
    };

    window.saveProfile = function() {
      const first = document.getElementById('firstName').value.trim();
      const last = document.getElementById('lastName').value.trim();

      if (!first) { showErr('err3', "Ismingizni kiriting"); return; }
      if (!last) { showErr('err3', "Familyangizni kiriting"); return; }

      const user = {
        phone: verifiedPhone,
        firstName: first,
        lastName: last,
        registeredAt: new Date().toISOString()
      };
      localStorage.setItem('kfc_user', JSON.stringify(user));
      localStorage.setItem('kfc_verified_phone', verifiedPhone);

      const from = sessionStorage.getItem('reg_from') || 'index.html';
      window.location.href = from;
    };
  </script>

</body>
</html>
