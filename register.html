<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>Ro'yxatdan o'tish</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #F5F5F5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* â”€â”€ Header â”€â”€ */
    .reg-header {
      background: linear-gradient(135deg, #FAB95B 0%, #F5A53A 100%);
      padding: 3rem 1.5rem 2rem;
      text-align: center;
      position: relative;
    }
    .reg-header::after {
      content: '';
      position: absolute;
      bottom: -20px; left: 50%;
      transform: translateX(-50%);
      width: 40px; height: 40px;
      background: #F5F5F5;
      border-radius: 50%;
    }
    .reg-logo {
      font-size: 3rem;
      margin-bottom: 0.75rem;
    }
    .reg-brand {
      font-size: 1.5rem;
      font-weight: 900;
      color: #fff;
      letter-spacing: -0.5px;
    }
    .reg-tagline {
      font-size: 0.85rem;
      color: rgba(255,255,255,0.85);
      margin-top: 0.25rem;
    }

    /* â”€â”€ Content â”€â”€ */
    .reg-content {
      flex: 1;
      padding: 2.5rem 1.25rem 2rem;
      max-width: 480px;
      margin: 0 auto;
      width: 100%;
    }

    /* â”€â”€ Steps indicator â”€â”€ */
    .steps {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0;
      margin-bottom: 2rem;
    }
    .step-dot {
      width: 32px; height: 32px;
      border-radius: 50%;
      background: #E0E0E0;
      color: #999;
      font-size: 0.8rem;
      font-weight: 800;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.3s;
      flex-shrink: 0;
    }
    .step-dot.active { background: #FAB95B; color: #fff; box-shadow: 0 0 0 4px rgba(250,185,91,0.2); }
    .step-dot.done { background: #4CAF50; color: #fff; }
    .step-line { height: 2px; width: 40px; background: #E0E0E0; transition: background 0.3s; }
    .step-line.done { background: #4CAF50; }

    /* â”€â”€ Card â”€â”€ */
    .reg-card {
      background: #fff;
      border-radius: 20px;
      padding: 1.75rem 1.25rem;
      box-shadow: 0 2px 16px rgba(0,0,0,0.06);
    }
    .card-icon { font-size: 2.5rem; text-align: center; margin-bottom: 0.75rem; }
    .card-title {
      font-size: 1.2rem; font-weight: 800;
      color: #202124; text-align: center;
      margin-bottom: 0.4rem;
    }
    .card-sub {
      font-size: 0.83rem; color: #888;
      text-align: center; margin-bottom: 1.5rem;
      line-height: 1.5;
    }

    /* â”€â”€ Inputs â”€â”€ */
    .input-group { margin-bottom: 1rem; }
    .input-label {
      font-size: 0.78rem; font-weight: 700;
      color: #555; margin-bottom: 0.4rem;
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    .input-wrap {
      display: flex; align-items: center;
      background: #F5F5F5;
      border-radius: 14px;
      border: 2px solid transparent;
      padding: 0 1rem;
      transition: all 0.2s;
    }
    .input-wrap:focus-within { border-color: #FAB95B; background: #fff; }
    .input-prefix {
      font-size: 1rem; font-weight: 700;
      color: #202124; flex-shrink: 0;
      margin-right: 0.3rem;
    }
    .input-wrap input, .single-input {
      flex: 1; border: none; background: transparent;
      font-size: 1rem; font-weight: 600;
      color: #202124; outline: none;
      padding: 0.85rem 0;
      width: 100%;
    }
    .single-input {
      background: #F5F5F5;
      border-radius: 14px;
      border: 2px solid transparent;
      padding: 0.85rem 1rem;
      transition: all 0.2s;
    }
    .single-input:focus { border-color: #FAB95B; background: #fff; outline: none; }

    /* OTP input */
    .otp-wrap {
      display: flex; gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .otp-wrap input {
      flex: 1; padding: 1rem 0;
      border: 2px solid #E0E0E0;
      border-radius: 14px;
      font-size: 1.6rem; font-weight: 800;
      text-align: center; letter-spacing: 4px;
      outline: none; color: #202124;
      transition: border-color 0.2s;
      background: #F5F5F5;
    }
    .otp-wrap input:focus { border-color: #FAB95B; background: #fff; }

    /* â”€â”€ Buttons â”€â”€ */
    .btn-primary {
      width: 100%; padding: 1rem;
      background: #FAB95B; color: #fff;
      border: none; border-radius: 14px;
      font-size: 1rem; font-weight: 800;
      cursor: pointer; transition: all 0.2s;
      margin-top: 0.5rem;
    }
    .btn-primary:active { transform: scale(0.98); opacity: 0.9; }
    .btn-primary:disabled { opacity: 0.5; }

    /* â”€â”€ Error & info â”€â”€ */
    .error-msg {
      font-size: 0.8rem; color: #E53935;
      text-align: center; min-height: 1.1rem;
      margin: 0.4rem 0;
    }
    .success-msg {
      font-size: 0.82rem; color: #4CAF50;
      text-align: center; font-weight: 600;
      margin-bottom: 0.75rem;
    }
    .resend-btn {
      text-align: center; font-size: 0.82rem;
      color: #FAB95B; cursor: pointer;
      margin-top: 0.75rem; font-weight: 600;
      text-decoration: underline;
    }
    .timer-txt {
      text-align: center; font-size: 0.8rem;
      color: #999; margin-top: 0.5rem;
    }

    /* â”€â”€ Step panels â”€â”€ */
    .step-panel { display: none; }
    .step-panel.active { display: block; }

    #recaptcha-container { display: none; }
  </style>
</head>
<body>

  <!-- Header -->
  <div class="reg-header">
    <button onclick="history.back()" style="position:absolute;top:1rem;left:1rem;background:rgba(255,255,255,0.25);border:none;border-radius:50%;width:38px;height:38px;display:flex;align-items:center;justify-content:center;cursor:pointer;">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5">
        <path d="M19 12H5M5 12l7 7M5 12l7-7"/>
      </svg>
    </button>
    <div class="reg-logo">ğŸ—</div>
    <div class="reg-brand">KFC Riston</div>
    <div class="reg-tagline">Tez va mazali taom yetkazish</div>
  </div>

  <div class="reg-content">

    <!-- Steps -->
    <div class="steps">
      <div class="step-dot active" id="dot1">1</div>
      <div class="step-line" id="line1"></div>
      <div class="step-dot" id="dot2">2</div>
      <div class="step-line" id="line2"></div>
      <div class="step-dot" id="dot3">3</div>
    </div>

    <div class="reg-card">

      <!-- STEP 1: Telefon raqam -->
      <div class="step-panel active" id="step1">
        <div class="card-icon">ğŸ“±</div>
        <div class="card-title">Telefon raqamingiz</div>
        <div class="card-sub">Telegram botimiz orqali tasdiqlash kodi yuboriladi</div>

        <div class="input-group">
          <div class="input-label">Telefon raqam</div>
          <div class="input-wrap">
            <span class="input-prefix">+998</span>
            <input type="tel" id="phoneInput" placeholder="90 123 45 67"
              maxlength="12" inputmode="numeric"
              oninput="this.value=this.value.replace(/[^0-9 ]/g,'')"
              onkeydown="if(event.key==='Enter') sendOTP()">
          </div>
        </div>

        <div class="error-msg" id="err1"></div>
        <!-- Telegram botda topilmadi xabari -->
        <div id="tgBotMsg" style="display:none; background:#FFF3E0; border-radius:12px; padding:1rem 1.1rem; margin-bottom:0.75rem; font-size:0.88rem; color:#BF360C; line-height:1.7; border: 1.5px solid #FFCCBC;">
          âš ï¸ <b>Telefon raqam botda saqlanmagan!</b><br><br>
          Avval <a href="https://t.me/demo_kfs_menu_bot" target="_blank" style="color:#1565C0;font-weight:700;">@demo_kfs_menu_bot</a> ga boring va raqamingizni yuboring, keyin qaytib urinib ko'ring.
        </div>
          </a>
        </div>
        <button class="btn-primary" id="sendBtn" onclick="sendOTP()">
          ğŸ“² Telegram orqali kod olish
        </button>
      </div>

      <!-- STEP 2: OTP kod -->
      <div class="step-panel" id="step2">
        <div class="card-icon">ğŸ”</div>
        <div class="card-title">Telegram kodini kiriting</div>
        <div class="success-msg" id="otpSentMsg"></div>

        <div class="otp-wrap">
          <input type="tel" id="otpInput" placeholder="------"
            maxlength="6" inputmode="numeric"
            oninput="this.value=this.value.replace(/[^0-9]/g,''); if(this.value.length===6) verifyOTP()">
        </div>

        <div class="error-msg" id="err2"></div>
        <button class="btn-primary" id="verifyBtn" onclick="verifyOTP()">
          âœ… Tasdiqlash
        </button>
        <div class="resend-btn" id="resendBtn" style="display:none" onclick="resendOTP()">
          ğŸ”„ Qaytadan Telegram ga yuborish
        </div>
        <div class="timer-txt" id="timerTxt"></div>
      </div>

      <!-- STEP 3: Ism familya -->
      <div class="step-panel" id="step3">
        <div class="card-icon">ğŸ‘¤</div>
        <div class="card-title">Ismingizni kiriting</div>
        <div class="card-sub">Bu ma'lumot buyurtma uchun ishlatiladi</div>

        <div class="input-group">
          <div class="input-label">Ism</div>
          <input type="text" class="single-input" id="firstName"
            placeholder="Masalan: Abdulloh" autocomplete="given-name"
            onkeydown="if(event.key==='Enter') document.getElementById('lastName').focus()">
        </div>
        <div class="input-group">
          <div class="input-label">Familya</div>
          <input type="text" class="single-input" id="lastName"
            placeholder="Masalan: Karimov" autocomplete="family-name"
            onkeydown="if(event.key==='Enter') saveProfile()">
        </div>

        <div class="error-msg" id="err3"></div>
        <button class="btn-primary" onclick="saveProfile()">
          âœ… Tasdiqlash va boshlash
        </button>
      </div>

    </div>
  </div>

  <script>
    // â”€â”€ Backend URL (index.html dagi bilan bir xil bo'lishi kerak) â”€â”€
    const API_URL = 'https://web-production-5aab6.up.railway.app';

    // â”€â”€ Allaqachon ro'yxatdan o'tgan bo'lsa â€” o'tkazib yuborish â”€â”€
    (function checkAlreadyRegistered(){
      try {
        const user = JSON.parse(localStorage.getItem('kfc_user') || 'null');
        if(user && user.phone && user.firstName && user.lastName){
          // Ro'yxatdan o'tgan â€” qaytish sahifasiga yo'naltirish
          const from = sessionStorage.getItem('reg_from') || 'index.html';
          window.location.replace(from);
        }
      } catch(e){}
    })();

    let verifiedPhone = null;
    let resendTimer = null;

    // â”€â”€ Bosqich (step) o'tish â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function goStep(n) {
      document.querySelectorAll('.step-panel').forEach(p => p.classList.remove('active'));
      document.getElementById('step' + n).classList.add('active');
      for (let i = 1; i <= 3; i++) {
        const dot = document.getElementById('dot' + i);
        dot.classList.remove('active', 'done');
        if (i < n) { dot.classList.add('done'); dot.textContent = 'âœ“'; }
        else if (i === n) dot.classList.add('active');
      }
      for (let i = 1; i <= 2; i++) {
        document.getElementById('line' + i).classList.toggle('done', i < n);
      }
    }

    function showErr(id, msg) { document.getElementById(id).textContent = msg; }
    function hideErr(id)      { document.getElementById(id).textContent = ''; }

    // â”€â”€ Resend timer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function startResendTimer() {
      let secs = 60;
      const txt = document.getElementById('timerTxt');
      const btn = document.getElementById('resendBtn');
      btn.style.display = 'none';
      txt.textContent = `${secs} soniyadan keyin qayta yuborish`;
      resendTimer = setInterval(() => {
        secs--;
        if (secs <= 0) {
          clearInterval(resendTimer);
          txt.textContent = '';
          btn.style.display = 'block';
        } else {
          txt.textContent = `${secs} soniyadan keyin qayta yuborish`;
        }
      }, 1000);
    }

    // â”€â”€ 1-qadam: Telegram orqali OTP yuborish â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.sendOTP = async function() {
      const raw = document.getElementById('phoneInput').value.replace(/\D/g, '');
      if (raw.length < 9) { showErr('err1', "Telefon raqamni to'liq kiriting"); return; }

      const phone = '+998' + raw.slice(-9);
      hideErr('err1');
      document.getElementById('tgBotMsg').style.display = 'none';

      const btn = document.getElementById('sendBtn');
      btn.disabled = true;
      btn.textContent = 'â³ Yuborilmoqda...';

      try {
        const res = await fetch(`${API_URL}/api/otp/send`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone })
        });

        const data = await res.json();

        // detail object yoki string bo'lishi mumkin
        const detail = data?.detail || data;
        const errMsg = typeof detail === 'object'
          ? (detail?.message || detail?.error || JSON.stringify(detail))
          : String(detail);
        const errCode = typeof detail === 'object' ? detail?.error : null;

        // Botda ro'yxatdan o'tmagan â€” istalgan ko'rinishda
        const isNotRegistered = res.status === 404 || errCode === 'not_registered' ||
          (typeof errMsg === 'string' && errMsg.includes('not_registered'));

        if (res.ok) {
          // Muvaffaqiyat â€” OTP yuborildi
          verifiedPhone = phone;
          document.getElementById('otpSentMsg').textContent =
            `âœ… ${phone} uchun Telegram ga kod yuborildi`;
          document.getElementById('otpInput').value = '';
          goStep(2);
          startResendTimer();
          setTimeout(() => document.getElementById('otpInput').focus(), 300);

        } else if (isNotRegistered) {
          // Botda ro'yxatdan o'tmagan â€” ko'k blok ko'rsatish
          document.getElementById('tgBotMsg').style.display = 'block';
          document.getElementById('tgBotMsg').scrollIntoView({ behavior: 'smooth' });
          btn.disabled = false;
          btn.textContent = 'ğŸ“² Telegram orqali kod olish';

        } else if (res.status === 429) {
          showErr('err1', errMsg || 'Biroz kuting va qayta urining');
          btn.disabled = false;
          btn.textContent = 'ğŸ“² Telegram orqali kod olish';

        } else {
          showErr('err1', errMsg || 'Xato. Qayta urining.');
          btn.disabled = false;
          btn.textContent = 'ğŸ“² Telegram orqali kod olish';
        }

      } catch(e) {
        showErr('err1', 'Server bilan aloqa yo\'q. Qayta urining.');
        btn.disabled = false;
        btn.textContent = 'ğŸ“² Telegram orqali kod olish';
      }
    };

    // â”€â”€ 2-qadam: OTP kodni tekshirish â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.verifyOTP = async function() {
      const code = document.getElementById('otpInput').value.trim();
      if (code.length < 4) { showErr('err2', 'Kodni kiriting'); return; }

      hideErr('err2');
      const btn = document.getElementById('verifyBtn');
      btn.disabled = true;
      btn.textContent = 'â³ Tekshirilmoqda...';

      try {
        const res = await fetch(`${API_URL}/api/otp/verify`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone: verifiedPhone, code })
        });

        const data = await res.json();
        const detail2 = data?.detail || data;
        const errMsg2 = typeof detail2 === 'object'
          ? (detail2?.message || detail2?.error || 'Noto\'g\'ri kod')
          : String(detail2);

        if (res.ok && data.success) {
          if (resendTimer) clearInterval(resendTimer);
          
          // Backend dan user ma'lumoti kelgan bo'lsa â€” avtomatik login
          if (data.user && data.user.firstName && data.user.lastName) {
            // Telegram da allaqachon ism/familya bor â€” saqlash va kirish
            localStorage.setItem('kfc_user', JSON.stringify({
              phone: data.user.phone,
              firstName: data.user.firstName,
              lastName: data.user.lastName,
              registeredAt: new Date().toISOString()
            }));
            localStorage.setItem('kfc_verified_phone', data.user.phone);
            const from = sessionStorage.getItem('reg_from') || 'index.html';
            window.location.replace(from);
            return;
          }
          
          // Yangi user â€” ism/familya so'rash
          document.getElementById('firstName').value = '';
          document.getElementById('lastName').value = '';
          goStep(3);
          setTimeout(() => document.getElementById('firstName').focus(), 300);

        } else {
          showErr('err2', errMsg2);
          btn.disabled = false;
          btn.textContent = 'âœ… Tasdiqlash';
        }

      } catch(e) {
        showErr('err2', 'Server bilan aloqa yo\'q.');
        btn.disabled = false;
        btn.textContent = 'âœ… Tasdiqlash';
      }
    };

    // â”€â”€ Qayta yuborish â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.resendOTP = function() {
      goStep(1);
      hideErr('err1');
      document.getElementById('tgBotMsg').style.display = 'none';
      document.getElementById('sendBtn').disabled = false;
      document.getElementById('sendBtn').textContent = 'ğŸ“² Telegram orqali kod olish';
    };

    // â”€â”€ 3-qadam: Ism/familya saqlash â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.saveProfile = function() {
      const first = document.getElementById('firstName').value.trim();
      const last  = document.getElementById('lastName').value.trim();
      if (!first) { showErr('err3', "Ismingizni kiriting"); return; }
      if (!last)  { showErr('err3', "Familyangizni kiriting"); return; }

      const user = {
        phone: verifiedPhone,
        firstName: first,
        lastName: last,
        registeredAt: new Date().toISOString()
      };
      localStorage.setItem('kfc_user', JSON.stringify(user));
      localStorage.setItem('kfc_verified_phone', verifiedPhone);

      const from = sessionStorage.getItem('reg_from') || 'index.html';
      window.location.href = from;
    };
  </script>

</body>
</html>
